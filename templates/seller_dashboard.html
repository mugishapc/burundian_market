{% extends "base.html" %}
{% block title %}Seller Dashboard{% endblock %}

{% block content %}
<!-- Subscription Status Banner - Mobile Optimized -->
{% if subscription_status %}
<div class="alert 
    {% if not subscription_status.active %}alert-danger
    {% elif subscription_status.days_left <= 3 %}alert-warning
    {% else %}alert-info{% endif %} mb-3 mb-md-4">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
        <div class="flex-grow-1 mb-2 mb-md-0">
            <h6 class="alert-heading mb-1 h6">
                <i class="fas fa-{% if not subscription_status.active %}exclamation-triangle{% elif subscription_status.days_left <= 3 %}clock{% else %}check-circle{% endif %} me-1 me-md-2"></i>
                Subscription Status
            </h6>
            {% if subscription_status.status == 'trial' %}
                <p class="mb-1 small">
                    <strong>Trial:</strong> 
                    {% if subscription_status.active %}
                        <span class="fw-bold">{{ subscription_status.days_left }} days left</span>
                        {% if subscription_status.days_left <= 3 %}
                            <br class="d-block d-md-none">
                            <a href="{{ url_for('seller_subscribe') }}" class="alert-link fw-bold small">Subscribe now!</a>
                        {% endif %}
                    {% else %}
                        <span class="fw-bold text-danger">ENDED</span>
                        <br class="d-block d-md-none">
                        <a href="{{ url_for('seller_subscribe') }}" class="alert-link fw-bold small">Subscribe to activate</a>
                    {% endif %}
                </p>
            {% elif subscription_status.status == 'subscription' %}
                <p class="mb-1 small">
                    <strong>Subscription:</strong> 
                    {% if subscription_status.active %}
                        <span class="fw-bold">{{ subscription_status.days_left }} days left</span>
                        {% if subscription_status.days_left <= 3 %}
                            <br class="d-block d-md-none">
                            <a href="{{ url_for('seller_subscribe') }}" class="alert-link fw-bold small">Renew now!</a>
                        {% endif %}
                    {% else %}
                        <span class="fw-bold text-danger">ENDED</span>
                        <br class="d-block d-md-none">
                        <a href="{{ url_for('seller_subscribe') }}" class="alert-link fw-bold small">Renew subscription</a>
                    {% endif %}
                </p>
            {% else %}
                <p class="mb-1 small">
                    <strong>Status:</strong> <span class="fw-bold text-danger">INACTIVE</span>
                    <br class="d-block d-md-none">
                    <a href="{{ url_for('seller_subscribe') }}" class="alert-link fw-bold small">Subscribe to start selling</a>
                </p>
            {% endif %}
            
            {% if subscription_status.active and subscription_status.days_left > 3 %}
                <p class="mb-0 mt-1 small">
                    <small>You can continue selling while active.</small>
                </p>
            {% endif %}
        </div>
        <div class="w-100 w-md-auto">
            <a href="{{ url_for('seller_subscribe') }}" class="btn 
                {% if not subscription_status.active %}btn-danger
                {% elif subscription_status.days_left <= 3 %}btn-warning
                {% else %}btn-info{% endif %} btn-sm w-100 w-md-auto">
                <i class="fas fa-shopping-cart me-1"></i>
                {% if subscription_status.status == 'trial' and subscription_status.active %}
                    Subscribe
                {% elif subscription_status.status == 'subscription' and subscription_status.active %}
                    Renew
                {% else %}
                    Activate
                {% endif %}
            </a>
        </div>
    </div>
</div>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-3 mb-md-4">
    <h2 class="h4 h2-md"><i class="fas fa-store me-2"></i>Seller Dashboard</h2>
    <div class="d-flex">
        {% if user.is_seller_active %}
            <a href="{{ url_for('add_product') }}" class="btn btn-success btn-sm me-1">
                <i class="fas fa-plus"></i> 
                <span class="d-none d-sm-inline">Add Product</span>
            </a>
        {% else %}
            <button class="btn btn-success btn-sm me-1" disabled title="Subscribe to add products">
                <i class="fas fa-plus"></i>
                <span class="d-none d-sm-inline">Add Product</span>
            </button>
        {% endif %}
        <a href="{{ url_for('convert_all_images') }}" class="btn btn-warning btn-sm">
            <i class="fas fa-sync"></i>
            <span class="d-none d-sm-inline">Convert</span>
        </a>
    </div>
</div>

<!-- Quick Stats - Mobile Optimized -->
<div class="row g-2 g-md-3 mb-3 mb-md-4">
    <div class="col-6 col-md-3">
        <div class="card bg-primary text-white h-100">
            <div class="card-body p-2 p-md-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0 fw-bold fs-6">{{ products|length }}</h6>
                        <p class="mb-0 small">Products</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-boxes fa-lg fa-2x-md"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card bg-success text-white h-100">
            <div class="card-body p-2 p-md-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0 fw-bold fs-6">
                            {% if subscription_status %}
                                {{ subscription_status.days_left }}
                            {% else %}
                                0
                            {% endif %}
                        </h6>
                        <p class="mb-0 small">Days Left</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-calendar-alt fa-lg fa-2x-md"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card bg-info text-white h-100">
            <div class="card-body p-2 p-md-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0 fw-bold fs-6">
                            {% if subscription_status and subscription_status.active %}
                                Active
                            {% else %}
                                Inactive
                            {% endif %}
                        </h6>
                        <p class="mb-0 small">Status</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-user-check fa-lg fa-2x-md"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card bg-warning text-white h-100">
            <div class="card-body p-2 p-md-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0 fw-bold fs-6">
                            {% if subscription_status %}
                                {{ subscription_status.status|title|truncate(3, True, '') }}
                            {% else %}
                                N/A
                            {% endif %}
                        </h6>
                        <p class="mb-0 small">Plan</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-crown fa-lg fa-2x-md"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3">
    <!-- Sidebar Content -->
    <div class="col-lg-4 col-md-5">
        <!-- Profile Card -->
        <div class="card">
            <div class="card-header bg-primary text-white py-2">
                <h5 class="card-title mb-0 h6"><i class="fas fa-user me-2"></i>My Profile</h5>
            </div>
            <div class="card-body p-2 p-md-3">
                <div class="mb-2">
                    <p class="mb-1 small"><strong><i class="fas fa-user me-2"></i>Username:</strong><br>{{ user.username }}</p>
                    <p class="mb-1 small"><strong><i class="fas fa-envelope me-2"></i>Email:</strong><br class="d-block d-sm-none">{{ user.email|truncate(20) }}</p>
                    <p class="mb-1 small"><strong><i class="fas fa-phone me-2"></i>Phone:</strong><br class="d-block d-sm-none">{{ user.phone or 'Not provided' }}</p>
                    <p class="mb-1 small">
                        <strong><i class="fas fa-shield-alt me-2"></i>Status:</strong> 
                        <span class="badge bg-{{ 'success' if user.is_verified else 'warning' }} small">
                            {{ 'Verified' if user.is_verified else 'Not Verified' }}
                        </span>
                    </p>
                    <p class="mb-2 small">
                        <strong><i class="fas fa-store me-2"></i>Seller:</strong> 
                        <span class="badge bg-{{ 'success' if user.is_seller_active else 'danger' }} small">
                            {{ 'Active' if user.is_seller_active else 'Inactive' }}
                        </span>
                    </p>
                </div>
                <div class="d-grid gap-1">
                    <a href="{{ url_for('edit_profile') }}" class="btn btn-primary btn-sm">
                        <i class="fas fa-user-edit"></i> Edit Profile
                    </a>
                    {% if not user.is_seller_active %}
                    <a href="{{ url_for('seller_subscribe') }}" class="btn btn-success btn-sm">
                        <i class="fas fa-shopping-cart"></i> Subscribe Now
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Products Summary Card -->
        <div class="card mt-3">
            <div class="card-header bg-success text-white py-2">
                <h5 class="card-title mb-0 h6"><i class="fas fa-chart-pie me-2"></i>Products Summary</h5>
            </div>
            <div class="card-body p-2 p-md-3">
                <div class="mb-2">
                    <p class="mb-1 small"><strong>Total:</strong> {{ products|length }}</p>
                    <p class="mb-1 small"><strong>With Images:</strong> 
                        <span class="text-success">{{ products|selectattr('image_data')|list|length }}</span>
                    </p>
                    <p class="mb-2 small"><strong>No Images:</strong> 
                        <span class="text-warning">{{ products|rejectattr('image_data')|list|length }}</span>
                    </p>
                </div>
                {% set with_images = products|selectattr('image_data')|list|length %}
                {% set total_products = products|length %}
                {% set image_percentage = (with_images / total_products * 100) if total_products > 0 else 0 %}
                <div class="progress mb-1" style="height: 15px;">
                    <div class="progress-bar bg-success" role="progressbar" 
                         style="width: {{ image_percentage }}%"
                         aria-valuenow="{{ image_percentage }}" aria-valuemin="0" aria-valuemax="100">
                        {{ "%.0f"|format(image_percentage) }}%
                    </div>
                </div>
                <small class="text-muted small">
                    {{ "%.0f"|format(image_percentage) }}% have images
                </small>
            </div>
        </div>

        <!-- Image Help Card -->
        <div class="card mt-3">
            <div class="card-header bg-info text-white py-2">
                <h5 class="card-title mb-0 h6"><i class="fas fa-images me-2"></i>Image Help</h5>
            </div>
            <div class="card-body p-2 p-md-3">
                <p class="small mb-2">
                    <strong>Image issues?</strong> Convert from base64 to file storage.
                </p>
                <div class="d-grid">
                    <a href="{{ url_for('convert_all_images') }}" class="btn btn-info btn-sm">
                        <i class="fas fa-sync me-1"></i>Convert Images
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Table -->
    <div class="col-lg-8 col-md-7">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center py-2">
                <h5 class="card-title mb-0 h6"><i class="fas fa-boxes me-2"></i>My Products</h5>
                <span class="badge bg-light text-primary">{{ products|length }}</span>
            </div>
            <div class="card-body p-1 p-md-3">
                {% if products %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-dark small">
                                <tr>
                                    <th class="d-none d-sm-table-cell">Image</th>
                                    <th>Title</th>
                                    <th class="d-none d-md-table-cell">Price</th>
                                    <th class="d-none d-lg-table-cell">Category</th>
                                    <th class="d-none d-xl-table-cell">Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in products %}
                                <tr>
                                    <td class="d-none d-sm-table-cell">
                                        {% if product.image_data %}
                                        <div class="product-image-container" style="width: 40px; height: 40px; position: relative;">
                                            <img src="{{ url_for('get_product_image', product_id=product.id) }}" 
                                                 alt="{{ product.title }}" 
                                                 class="product-table-image"
                                                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;"
                                                 loading="lazy">
                                        </div>
                                        {% else %}
                                        <div class="image-fallback" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 4px; border: 1px dashed #dee2e6;">
                                            <i class="fas fa-image text-muted small"></i>
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong class="small">{{ product.title|truncate(20) }}</strong>
                                        <div class="d-block d-md-none">
                                            <small class="text-success fw-bold">{{ product.price|format_currency }} BIF</small>
                                        </div>
                                        {% if product.description %}
                                        <br><small class="text-muted d-none d-md-inline">{{ product.description[:30] }}{% if product.description|length > 30 %}...{% endif %}</small>
                                        {% endif %}
                                        {% if not product.image_data %}
                                        <br><small class="text-warning small d-none d-sm-inline"><i class="fas fa-exclamation-triangle"></i> No image</small>
                                        {% endif %}
                                    </td>
                                    <td class="d-none d-md-table-cell">
                                        <strong class="small">{{ product.price|format_currency }} BIF</strong>
                                    </td>
                                    <td class="d-none d-lg-table-cell">
                                        <span class="badge bg-secondary small">{{ product.category|truncate(10) or 'General' }}</span>
                                    </td>
                                    <td class="d-none d-xl-table-cell">
                                        <small class="text-muted">{{ product.created_at.strftime('%m-%d') }}</small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{{ url_for('product_detail', product_id=product.id) }}" 
                                               class="btn btn-outline-primary btn-sm py-1" 
                                               title="View">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% if user.is_seller_active %}
                                            <a href="{{ url_for('edit_product', product_id=product.id) }}" 
                                               class="btn btn-outline-warning btn-sm py-1"
                                               title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <form action="{{ url_for('delete_product', product_id=product.id) }}" 
                                                  method="POST" 
                                                  class="d-inline"
                                                  onsubmit="return confirm('Delete {{ product.title }}?');">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <button type="submit" class="btn btn-outline-danger btn-sm py-1" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                            {% else %}
                                            <button class="btn btn-outline-warning btn-sm py-1" disabled title="Subscribe to edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm py-1" disabled title="Subscribe to delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                {% else %}
                    <div class="text-center py-4 py-md-5">
                        <i class="fas fa-box-open text-muted mb-3 fa-2x"></i>
                        <h5 class="text-muted h6">No Products Yet</h5>
                        <p class="text-muted mb-3 small">You haven't listed any products yet.</p>
                        {% if user.is_seller_active %}
                            <a href="{{ url_for('add_product') }}" class="btn btn-success btn-sm">
                                <i class="fas fa-plus me-2"></i>Add First Product
                            </a>
                        {% else %}
                            <div class="alert alert-warning py-2">
                                <p class="mb-1 small">Subscription required to add products.</p>
                                <a href="{{ url_for('seller_subscribe') }}" class="btn btn-warning btn-sm">
                                    <i class="fas fa-shopping-cart me-1"></i>Subscribe
                                </a>
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.product-table-image {
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.product-table-image:hover {
    border-color: #007bff;
}

.image-fallback {
    transition: all 0.3s ease;
}

.image-fallback:hover {
    background-color: #e9ecef !important;
}

.product-image-container {
    overflow: hidden;
    border-radius: 4px;
}

/* Mobile-specific improvements */
@media (max-width: 768px) {
    .card-header {
        padding: 0.5rem 0.75rem;
    }
    
    .card-body {
        padding: 0.75rem;
    }
    
    .table td, .table th {
        padding: 0.4rem 0.3rem;
        font-size: 0.8rem;
    }
    
    .btn-group-sm > .btn {
        padding: 0.2rem 0.3rem;
        margin: 0 1px;
    }
    
    .badge {
        font-size: 0.7rem;
    }
}

/* Extra small devices */
@media (max-width: 576px) {
    .col-6 {
        margin-bottom: 0.5rem;
    }
    
    .alert {
        padding: 0.75rem;
    }
    
    .alert-heading {
        font-size: 0.9rem;
    }
    
    .table-responsive {
        font-size: 0.8rem;
    }
}

/* Better touch targets */
.btn, .nav-link {
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-sm {
    min-height: 36px;
}

/* Responsive font sizes */
@media (max-width: 768px) {
    .h2-md { font-size: 1.5rem; }
    .fa-2x-md { font-size: 1.5em; }
}

/* Improved table scrolling for mobile */
.table-responsive {
    -webkit-overflow-scrolling: touch;
}

/* Card animations */
.card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* Progress bar improvements */
.progress {
    border-radius: 10px;
}

.progress-bar {
    border-radius: 10px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Mobile-optimized seller dashboard loaded');
    
    // Mobile touch improvements
    document.querySelectorAll('.btn, .nav-link').forEach(element => {
        element.style.minHeight = '44px';
    });
    
    // Better mobile table scrolling
    const tables = document.querySelectorAll('.table-responsive');
    tables.forEach(table => {
        table.style.webkitOverflowScrolling = 'touch';
    });
    
    // Mobile-optimized image loading
    const productImages = document.querySelectorAll('.product-table-image');
    productImages.forEach(img => {
        img.addEventListener('error', function() {
            console.log('Product table image failed to load:', this.alt);
            this.style.display = 'none';
            const container = this.parentElement;
            if (container && container.classList.contains('product-image-container')) {
                const fallback = document.createElement('div');
                fallback.className = 'image-fallback';
                fallback.style.cssText = 'width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 4px; border: 1px dashed #dee2e6;';
                fallback.innerHTML = '<i class="fas fa-image text-muted small"></i>';
                container.appendChild(fallback);
            }
        });
        
        img.addEventListener('load', function() {
            console.log('Product table image loaded:', this.alt);
        });
    });
    
    // Auto-refresh subscription status every 5 minutes
    setInterval(function() {
        // Only refresh if subscription is active and might expire soon
        const activeBadge = document.querySelector('.badge.bg-success');
        if (activeBadge && activeBadge.textContent.includes('Active')) {
            location.reload();
        }
    }, 300000); // 5 minutes
    
    // Mobile swipe support for product table
    let touchStartX = 0;
    let touchEndX = 0;
    
    document.querySelectorAll('tbody tr').forEach(row => {
        row.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        });
        
        row.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe(row);
        });
    });
    
    function handleSwipe(row) {
        const swipeDistance = touchEndX - touchStartX;
        if (Math.abs(swipeDistance) > 50) { // Minimum swipe distance
            if (swipeDistance > 0) {
                // Right swipe - view product
                const viewBtn = row.querySelector('a[href*="product_detail"]');
                if (viewBtn) viewBtn.click();
            } else {
                // Left swipe - show actions
                const editBtn = row.querySelector('a[href*="edit_product"]');
                if (editBtn && !editBtn.disabled) editBtn.click();
            }
        }
    }
    
    // Mobile-optimized progress animation
    const progressBars = document.querySelectorAll('.progress-bar');
    progressBars.forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0%';
        setTimeout(() => {
            bar.style.transition = 'width 1s ease-in-out';
            bar.style.width = width;
        }, 100);
    });
});
</script>
{% endblock %}